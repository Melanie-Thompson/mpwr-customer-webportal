version: 2.1

# MPWR Customer Portal CI/CD Pipeline
# CircleCI Orbs
orbs:
  aws-cli: circleci/aws-cli@4.1.3
  node: circleci/node@5.2.0

# Reusable commands
commands:
  setup_node_dependencies:
    description: "Install and cache Node dependencies"
    steps:
      - node/install-packages:
          pkg-manager: npm
          cache-version: v2
          include-branch-in-cache-key: false

# Jobs
jobs:
  # Code quality checks
  lint:
    docker:
      - image: cimg/node:20.11
    resource_class: medium
    steps:
      - checkout
      - setup_node_dependencies
      - run:
          name: Run ESLint
          command: npm run lint || true

  # Build customer portal
  build:
    docker:
      - image: cimg/node:20.11
    resource_class: large
    parameters:
      environment:
        type: string
        default: "dev"
    steps:
      - checkout
      - setup_node_dependencies
      - run:
          name: Set environment variables for build
          command: |
            ENV="<< parameters.environment >>"

            echo "VITE_ENVIRONMENT=${ENV}" > .env
            echo "VITE_API_BASE_URL=${VITE_API_BASE_URL}" >> .env

            echo "Build configuration:"
            cat .env
      - run:
          name: Build customer portal
          command: |
            npm run build

            # Move to environment-specific folder
            ENV="<< parameters.environment >>"
            mkdir -p dist-${ENV}
            mv dist/* dist-${ENV}/
            rmdir dist

            # Build stats
            echo "Build complete!"
            du -sh dist-${ENV}/
            echo "Files in build:"
            find dist-${ENV}/ -type f | wc -l
      - persist_to_workspace:
          root: .
          paths:
            - dist-<< parameters.environment >>
      - store_artifacts:
          path: dist-<< parameters.environment >>
          destination: customer-portal-build-<< parameters.environment >>

  # Deploy to S3 and CloudFront
  deploy:
    docker:
      - image: cimg/python:3.13-node
    resource_class: medium
    parameters:
      environment:
        type: string
        default: "dev"
    steps:
      - checkout
      - attach_workspace:
          at: .
      - aws-cli/install
      - run:
          name: Setup AWS OIDC
          command: |
            # Use OIDC token for authentication
            OIDC_TOKEN="${CIRCLE_OIDC_TOKEN_V2:-$CIRCLE_OIDC_TOKEN}"
            ROLE_ARN="${AWS_ROLE_ARN}"

            echo "Assuming role: $ROLE_ARN"

            aws sts assume-role-with-web-identity \
              --role-arn "$ROLE_ARN" \
              --role-session-name "circleci-customer-portal-${CIRCLE_BUILD_NUM}" \
              --web-identity-token "$OIDC_TOKEN" \
              --duration-seconds 3600 > /tmp/creds.json

            export AWS_ACCESS_KEY_ID=$(cat /tmp/creds.json | jq -r '.Credentials.AccessKeyId')
            export AWS_SECRET_ACCESS_KEY=$(cat /tmp/creds.json | jq -r '.Credentials.SecretAccessKey')
            export AWS_SESSION_TOKEN=$(cat /tmp/creds.json | jq -r '.Credentials.SessionToken')

            echo "export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID" >> $BASH_ENV
            echo "export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY" >> $BASH_ENV
            echo "export AWS_SESSION_TOKEN=$AWS_SESSION_TOKEN" >> $BASH_ENV
            echo "export AWS_REGION=${AWS_REGION:-us-east-1}" >> $BASH_ENV

            rm /tmp/creds.json
            echo "AWS credentials configured"
      - run:
          name: Sync to S3
          command: |
            ENV="<< parameters.environment >>"
            echo "Deploying customer portal to ${CUSTOMER_PORTAL_S3_BUCKET}"

            # Sync assets with long cache
            aws s3 sync dist-${ENV}/ s3://${CUSTOMER_PORTAL_S3_BUCKET}/ \
              --delete \
              --cache-control "public, max-age=31536000, immutable" \
              --exclude "*.html"

            # Sync HTML with no-cache
            aws s3 sync dist-${ENV}/ s3://${CUSTOMER_PORTAL_S3_BUCKET}/ \
              --exclude "*" \
              --include "*.html" \
              --cache-control "no-cache, no-store, must-revalidate"
      - run:
          name: Invalidate CloudFront
          command: |
            echo "Invalidating CloudFront ${CUSTOMER_PORTAL_CLOUDFRONT_ID}"

            INVALIDATION_ID=$(aws cloudfront create-invalidation \
              --distribution-id ${CUSTOMER_PORTAL_CLOUDFRONT_ID} \
              --paths "/*" \
              --query 'Invalidation.Id' \
              --output text)

            echo "Created invalidation: ${INVALIDATION_ID}"

            aws cloudfront wait invalidation-completed \
              --distribution-id ${CUSTOMER_PORTAL_CLOUDFRONT_ID} \
              --id ${INVALIDATION_ID}

            echo "Deployment complete!"

# Workflows
workflows:
  build_and_deploy:
    jobs:
      - lint:
          filters:
            branches:
              only: /.*/

      # Dev deployment (main branch auto-deploy)
      - build:
          name: build_dev
          environment: "dev"
          requires:
            - lint
          context:
            - customer-portal-dev
          filters:
            branches:
              only: main

      - deploy:
          name: deploy_dev
          environment: "dev"
          requires:
            - build_dev
          context:
            - aws-credentials-dev
            - customer-portal-dev
          filters:
            branches:
              only: main

      # Prod deployment (requires approval)
      - build:
          name: build_prod
          environment: "prod"
          requires:
            - lint
          context:
            - customer-portal-prod
          filters:
            branches:
              only: main

      - hold_for_prod_approval:
          type: approval
          requires:
            - deploy_dev
            - build_prod
          filters:
            branches:
              only: main

      - deploy:
          name: deploy_prod
          environment: "prod"
          requires:
            - hold_for_prod_approval
          context:
            - aws-credentials-prod
            - customer-portal-prod
          filters:
            branches:
              only: main
